services:
  #########
  # Proxy #
  #########
  traefik:
    image: traefik:latest
    security_opt:
      - no-new-privileges:true
    command:
      - --log
      - --log.level=${LOG_LEVEL:-INFO}
      - --providers.docker=true
      - --providers.docker.exposedByDefault=false
      - --serversTransport.insecureSkipVerify=true # Allow self-signed certificates for target hosts
      - "--entrypoints.web.forwardedHeaders.trustedIPs=172.29.5.2/32" # Let Cloudflare set forwarded headers
      - --entrypoints.web.address=:80
    restart: unless-stopped
    ports:
      - "80:80"
    networks:
      tunnel:
        ipv4_address: 172.29.5.3
      default:
    labels:
      - "stack-back.volumes=false" # disable volume backups for this container
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
  cloudflared:
    image: cloudflare/cloudflared:latest
    user: "1000:1000"
    command: tunnel run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    restart: unless-stopped
    networks:
      tunnel:
        ipv4_address: 172.29.5.2
    environment:
      - TUNNEL_URL=http://traefik:80
    labels:
      - "stack-back.volumes=false" # disable volume backups for this container
    volumes:
      - /etc/localtime:/etc/localtime:ro

networks:
  tunnel:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.5.0/24
          gateway: 172.29.5.1
          ip_range: 172.29.5.0/30
